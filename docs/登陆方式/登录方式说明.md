# Outline 登录方式说明

本文档详细介绍了 Outline 项目支持的所有登录认证方式。

## 概述

Outline 支持 **7 种登录方式**，分为两大类：

1. **内置认证方式**（2种）：
   - Email（邮箱魔法链接登录）
   - Passkeys（WebAuthn 密钥登录）

2. **OAuth 第三方认证**（5种）：
   - Google OAuth
   - Microsoft Azure AD
   - OIDC（OpenID Connect）
   - Slack OAuth
   - Discord OAuth

---

## 1. Email 登录（邮箱魔法链接）

### 简介

Email 登录是一种**无密码登录方式**，通过发送包含登录链接或验证码的邮件来完成身份验证。

### 工作原理

1. 用户在登录页面输入邮箱地址
2. 系统发送邮件，包含：
   - **登录链接**（点击即可登录）
   - **6位验证码**（可选，用于输入验证）
3. 用户点击邮件中的链接或输入验证码完成登录

### 特点

- ✅ 无需记住密码
- ✅ 安全性高（链接有时效性）
- ✅ 适合所有用户
- ⚠️ 需要配置 SMTP 服务器
- ⚠️ 依赖邮件服务可用性

### 配置要求

#### 1. 配置 SMTP 服务器

在环境变量中配置以下选项之一：

**方式1：使用 MailHog（开发/测试环境）**

```bash
SMTP_HOST=mailhog
SMTP_PORT=1025
SMTP_SECURE=false
SMTP_FROM_EMAIL=noreply@outline.local
```

> **注意**：MailHog 会捕获所有邮件并在 Web UI（`http://your-server:8025`）中显示，适合开发和测试。

**方式2：使用预设 SMTP 服务（生产环境）**

```bash
SMTP_SERVICE=gmail  # 可选：gmail, qq, 163, outlook 等
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_FROM_EMAIL=noreply@yourdomain.com
```

**方式3：使用自定义 SMTP 服务器**

```bash
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_SECURE=true
SMTP_FROM_EMAIL=noreply@yourdomain.com
```

#### 2. 在 Web 界面启用

1. 登录 Outline 管理界面
2. 进入 **Settings（设置）** → **Authentication（认证）**
3. 找到 **Email** 选项
4. 启用开关（`guestSignin`）

### 使用场景

- 企业内部使用
- 不想管理密码的场景
- 需要快速登录的场景

---

## 2. Passkeys（密钥登录）

### 简介

Passkeys 是基于 **WebAuthn** 标准的无密码认证方式，使用设备的生物识别（Face ID、Touch ID、Windows Hello）或安全密钥进行身份验证。

### 工作原理

1. 用户在设备上注册 Passkey
2. 登录时使用生物识别或安全密钥验证
3. 无需输入密码

### 特点

- ✅ 最安全的登录方式
- ✅ 无需密码
- ✅ 支持生物识别
- ✅ 支持硬件安全密钥
- ⚠️ 需要现代浏览器和设备支持
- ⚠️ 需要在 Team 设置中启用

### 配置要求

#### 1. 在 Web 界面启用

1. 登录 Outline 管理界面
2. 进入 **Settings（设置）** → **Authentication（认证）**
3. 找到 **Passkeys** 选项
4. 启用开关（`passkeysEnabled`）

#### 2. 用户注册 Passkey

1. 用户登录后进入 **Settings（设置）** → **Security（安全）** → **Passkeys**
2. 点击 **Add Passkey（添加密钥）**
3. 使用设备生物识别或安全密钥完成注册

### 使用场景

- 对安全性要求极高的场景
- 企业环境
- 个人用户追求便捷和安全

---

## 3. Google OAuth

### 简介

使用 Google 账号进行单点登录（SSO），用户可以使用现有的 Google 账号登录 Outline。

### 特点

- ✅ 用户无需创建新账号
- ✅ 使用 Google 的安全机制
- ✅ 适合已有 Google 账号的用户
- ⚠️ 需要配置 Google OAuth 应用

### 配置要求

#### 1. 创建 Google OAuth 应用

1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 创建新项目或选择现有项目
3. 启用 **Google+ API**
4. 创建 **OAuth 2.0 客户端 ID**
5. 配置授权重定向 URI：`https://your-domain.com/auth/google.callback`

#### 2. 配置环境变量

```bash
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

#### 3. 在 Web 界面启用

1. 登录 Outline 管理界面
2. 进入 **Settings（设置）** → **Authentication（认证）**
3. 找到 **Google** 选项
4. 点击 **Connect（连接）** 并完成配置

### 使用场景

- 个人用户
- 使用 Google Workspace 的企业
- 快速部署场景

---

## 4. Microsoft Azure AD

### 简介

使用 Microsoft Azure Active Directory 进行企业级单点登录，适合使用 Microsoft 365 的企业。

### 特点

- ✅ 企业级安全
- ✅ 与 Microsoft 365 集成
- ✅ 支持条件访问策略
- ⚠️ 需要 Azure AD 订阅
- ⚠️ 配置相对复杂

### 配置要求

#### 1. 在 Azure Portal 注册应用

1. 登录 [Azure Portal](https://portal.azure.com/)
2. 进入 **Azure Active Directory** → **App registrations**
3. 创建新应用注册
4. 配置重定向 URI：`https://your-domain.com/auth/azure.callback`
5. 获取 **Application (client) ID** 和 **Client secret**

#### 2. 配置环境变量

```bash
AZURE_CLIENT_ID=your-azure-client-id
AZURE_CLIENT_SECRET=your-azure-client-secret
```

#### 3. 在 Web 界面启用

1. 登录 Outline 管理界面
2. 进入 **Settings（设置）** → **Authentication（认证）**
3. 找到 **Microsoft** 选项
4. 点击 **Connect（连接）** 并完成配置

### 使用场景

- 使用 Microsoft 365 的企业
- 需要企业级 SSO 的场景
- 需要与 Active Directory 集成的场景

---

## 5. OIDC（OpenID Connect）

### 简介

OIDC 是一个通用的身份认证标准，支持任何兼容 OIDC 的身份提供商（如 Okta、Auth0、Keycloak 等）。

### 特点

- ✅ 通用性强，支持多种身份提供商
- ✅ 标准协议，兼容性好
- ✅ 适合企业自建身份系统
- ⚠️ 需要配置 OIDC 提供商
- ⚠️ 配置相对复杂

### 配置要求

#### 1. 配置 OIDC 提供商

需要从你的 OIDC 提供商获取：
- Client ID
- Client Secret
- Issuer URL（或手动配置 Auth URI、Token URI、UserInfo URI）

#### 2. 配置环境变量

**方式1：使用 Issuer URL（推荐）**

```bash
OIDC_CLIENT_ID=your-oidc-client-id
OIDC_CLIENT_SECRET=your-oidc-client-secret
OIDC_ISSUER_URL=https://your-oidc-provider.com
OIDC_DISPLAY_NAME=Your OIDC Provider  # 可选，自定义显示名称
```

**方式2：手动配置**

```bash
OIDC_CLIENT_ID=your-oidc-client-id
OIDC_CLIENT_SECRET=your-oidc-client-secret
OIDC_AUTH_URI=https://your-oidc-provider.com/authorize
OIDC_TOKEN_URI=https://your-oidc-provider.com/token
OIDC_USERINFO_URI=https://your-oidc-provider.com/userinfo
OIDC_DISPLAY_NAME=Your OIDC Provider
```

#### 3. 在 Web 界面启用

1. 登录 Outline 管理界面
2. 进入 **Settings（设置）** → **Authentication（认证）**
3. 找到 **OIDC** 选项
4. 点击 **Connect（连接）** 并完成配置

### 使用场景

- 企业自建身份系统
- 使用 Okta、Auth0 等身份提供商
- 需要统一身份管理的场景

---

## 6. Slack OAuth

### 简介

使用 Slack 账号进行登录，适合使用 Slack 进行团队协作的组织。

### 特点

- ✅ 与 Slack 集成
- ✅ 支持 Slack 斜杠命令（`/outline`）
- ✅ 支持链接预览
- ⚠️ 需要创建 Slack App

### 配置要求

#### 1. 创建 Slack App

1. 访问 [Slack API](https://api.slack.com/apps)
2. 创建新 App
3. 配置 OAuth & Permissions：
   - 添加重定向 URI：`https://your-domain.com/auth/slack.callback`
   - 设置所需权限（scopes）
4. 获取 **Client ID** 和 **Client Secret**

#### 2. 配置环境变量

```bash
SLACK_CLIENT_ID=your-slack-client-id
SLACK_CLIENT_SECRET=your-slack-client-secret
```

#### 3. 在 Web 界面启用

1. 登录 Outline 管理界面
2. 进入 **Settings（设置）** → **Authentication（认证）**
3. 找到 **Slack** 选项
4. 点击 **Connect（连接）** 并完成配置

### 使用场景

- 使用 Slack 进行团队协作的组织
- 需要 Slack 集成的场景

---

## 7. Discord OAuth

### 简介

使用 Discord 账号进行登录，适合游戏社区、开发者社区等使用 Discord 的场景。

### 特点

- ✅ 适合 Discord 用户
- ✅ 配置简单
- ⚠️ 需要创建 Discord Application

### 配置要求

#### 1. 创建 Discord Application

1. 访问 [Discord Developer Portal](https://discord.com/developers/applications)
2. 创建新 Application
3. 进入 **OAuth2** 页面
4. 添加重定向 URI：`https://your-domain.com/auth/discord.callback`
5. 获取 **Client ID** 和 **Client Secret**

#### 2. 配置环境变量

```bash
DISCORD_CLIENT_ID=your-discord-client-id
DISCORD_CLIENT_SECRET=your-discord-client-secret
```

#### 3. 在 Web 界面启用

1. 登录 Outline 管理界面
2. 进入 **Settings（设置）** → **Authentication（认证）**
3. 找到 **Discord** 选项
4. 点击 **Connect（连接）** 并完成配置

### 使用场景

- 游戏社区
- 开发者社区
- 使用 Discord 的组织

---

## 登录方式对比

| 登录方式 | 类型 | 安全性 | 易用性 | 配置难度 | 适用场景 |
|---------|------|--------|--------|----------|----------|
| Email | 内置 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ | 通用 |
| Passkeys | 内置 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐ | 高安全要求 |
| Google | OAuth | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ | 个人/小团队 |
| Azure AD | OAuth | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | 企业 |
| OIDC | OAuth | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | 企业自建 |
| Slack | OAuth | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | Slack 用户 |
| Discord | OAuth | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | Discord 用户 |

---

## 配置优先级

Outline 支持同时启用多种登录方式，用户可以在登录页面选择使用哪种方式登录。

### 登录方式优先级

在登录页面，登录方式按以下优先级显示：

1. **Email** 和 **Passkeys**（优先级最高，显示在最前面）
2. 其他 OAuth 方式按配置顺序显示

### 特殊说明

- **Email** 和 **Passkeys** 是特殊的认证方式，不需要在 `authentication_providers` 表中创建记录
- 其他 OAuth 方式需要在数据库中创建 `AuthenticationProvider` 记录
- 如果用户已关联某个 OAuth 账号，使用 Email 登录时会自动重定向到对应的 OAuth 登录页面

---

## 常见问题

### Q1: 可以同时启用多种登录方式吗？

**A:** 可以。Outline 支持同时启用多种登录方式，用户可以在登录页面选择使用哪种方式。

### Q2: Email 登录和 Passkeys 有什么区别？

**A:** 
- **Email 登录**：通过邮件链接或验证码登录，需要访问邮箱
- **Passkeys**：使用设备生物识别或安全密钥登录，无需访问邮箱，安全性更高

### Q3: 如何禁用某个登录方式？

**A:** 
- 对于 OAuth 方式：在 **Settings → Authentication** 中，找到对应的选项，点击 **Disable（禁用）**
- 对于 Email 和 Passkeys：在 **Settings → Authentication** 中，关闭对应的开关

### Q4: 生产环境推荐使用哪些登录方式？

**A:** 
- **推荐组合**：
  - Email + Google OAuth（适合个人和小团队）
  - Email + Azure AD（适合企业）
  - Email + OIDC（适合自建身份系统）
  - Passkeys（可选，提供最高安全性）

### Q5: MailHog 可以用于生产环境吗？

**A:** **不可以**。MailHog 仅用于开发和测试环境。生产环境应使用真实的 SMTP 服务器（如 Gmail、SendGrid、AWS SES 等）。

---

## 相关文档

- [环境部署文档](../环境部署/DEPLOYMENT.md)
- [Dokploy 部署指南](../环境部署/DOKPLOY_DEPLOYMENT.md)
- [架构文档](../ARCHITECTURE.md)

---

## 更新日志

- **2024-01-XX**: 初始版本，包含所有 7 种登录方式的详细说明
