# 局域网 SSL 证书配置说明

## 概述

`install-local-ssl.js` 脚本支持通过 CIDR 网段或单个 IP 地址来生成包含局域网 IP 的 SSL 证书。

## 环境变量说明

### LOCAL_NETWORK（推荐）

支持 CIDR 网段格式或单个 IP 地址，多个值用逗号分隔。

**示例：**

```bash
# 单个 CIDR 网段（智能展开）
LOCAL_NETWORK=192.168.0.0/16

# 多个网段
LOCAL_NETWORK=192.168.0.0/16,10.0.0.0/8

# 混合：网段 + 单个 IP
LOCAL_NETWORK=192.168.0.0/16,192.168.1.100

# 单个 IP（向后兼容）
LOCAL_NETWORK=192.168.1.255
```

### LOCAL_IP（向后兼容）

与 `LOCAL_NETWORK` 功能相同，但推荐使用 `LOCAL_NETWORK`。

```bash
LOCAL_IP=192.168.1.255
LOCAL_IP=192.168.1.255,192.168.1.100
```

### EXPAND_NETWORK_ALL

控制 CIDR 网段的展开方式：

- `false`（默认）：智能展开，只包含关键 IP
- `true`：完整展开，包含网段内所有 IP

**注意**：完整展开大网段（如 `/16`）会产生大量 IP，可能导致证书过大。

### LOCAL_DOMAIN

指定本地域名（默认：`local.outline.dev`）

```bash
LOCAL_DOMAIN=outline.local
```

### FORCE_REGENERATE_CERT

强制重新生成证书（即使证书已存在）

```bash
FORCE_REGENERATE_CERT=true
```

## CIDR 网段展开规则

### 智能展开（默认，EXPAND_NETWORK_ALL=false）

对于不同大小的网段，智能展开包含以下关键 IP：

#### /24 网段（如 192.168.1.0/24）
- `.0` - 网络地址
- `.1` - 通常的网关地址
- `.255` - 广播地址

#### /16 网段（如 192.168.0.0/16）
- 网络地址和广播地址
- 前 10 个子网的网关（.1）和广播（.255）
  - 192.168.1.1, 192.168.1.255
  - 192.168.2.1, 192.168.2.255
  - ...
  - 192.168.10.1, 192.168.10.255

#### /8 网段（如 10.0.0.0/8）
- 网络地址和广播地址
- 前 11 个子网的网关和广播地址

### 完整展开（EXPAND_NETWORK_ALL=true）

展开网段内**所有** IP 地址：

- `/24` 网段：256 个 IP
- `/16` 网段：65,536 个 IP ⚠️ **证书会非常大**
- `/8` 网段：16,777,216 个 IP ⚠️ **不推荐**

## 使用示例

### 示例 1：配置 192.168.0.0/16 网段（智能展开）

```bash
# 在宿主机上
LOCAL_NETWORK=192.168.0.0/16 yarn install-local-ssl

# 在 Docker 容器内
docker exec -e LOCAL_NETWORK=192.168.0.0/16 outline yarn install-local-ssl
```

**生成的证书包含：**
- 域名：`local.outline.dev`, `*.outline.dev`, `localhost`
- IP：`127.0.0.1`
- 网段关键 IP：`192.168.0.0`, `192.168.0.1`, `192.168.0.255`, `192.168.1.1`, `192.168.1.255`, ...（约 20+ 个 IP）

### 示例 2：配置多个网段

```bash
LOCAL_NETWORK=192.168.0.0/16,10.0.0.0/8 yarn install-local-ssl
```

### 示例 3：完整展开网段（不推荐）

```bash
# 只对 /24 网段完整展开是安全的
LOCAL_NETWORK=192.168.1.0/24 EXPAND_NETWORK_ALL=true yarn install-local-ssl
```

### 示例 4：强制重新生成证书

```bash
# 删除旧证书
rm -f server/config/certs/public.cert server/config/certs/private.key

# 重新生成
LOCAL_NETWORK=192.168.0.0/16 FORCE_REGENERATE_CERT=true yarn install-local-ssl
```

### 示例 5：在 docker-compose 中配置

在 `dokploy-env.txt` 或环境变量文件中添加：

```bash
# 局域网网段配置
LOCAL_NETWORK=192.168.0.0/16
LOCAL_DOMAIN=local.outline.dev
```

然后在容器启动后运行：

```bash
docker exec outline yarn install-local-ssl
```

## 验证证书

### 检查证书包含的 IP

```bash
# 查看证书详细信息
docker exec outline openssl x509 -in /opt/outline/server/config/certs/public.cert -noout -text

# 只查看 SAN（Subject Alternative Name）
docker exec outline openssl x509 -in /opt/outline/server/config/certs/public.cert -noout -text | grep -A 20 "Subject Alternative Name"
```

### 测试连接

```bash
# 从局域网设备测试
curl -v https://192.168.1.255:3300/
curl -v https://192.168.1.1:3300/
curl -v https://local.outline.dev:3300/
```

## 常见问题

### Q1: 为什么我的局域网 IP 不在证书中？

**A:** 检查以下几点：
1. 确认 `LOCAL_NETWORK` 环境变量已设置
2. 确认 IP 地址在指定的网段范围内
3. 如果使用智能展开，某些 IP 可能不在关键 IP 列表中
4. 使用 `EXPAND_NETWORK_ALL=true` 完整展开（仅适用于小网段）

### Q2: 证书太大怎么办？

**A:** 
- 不要使用 `EXPAND_NETWORK_ALL=true` 展开大网段
- 使用智能展开（默认）
- 或者只指定具体的 IP 地址，而不是整个网段

### Q3: 如何清除浏览器的 HSTS 缓存？

**A:**
- Chrome: 访问 `chrome://net-internals/#hsts`，在 "Delete domain security policies" 中输入域名并删除
- Firefox: 清除浏览器数据中的 "站点数据"
- 或者使用隐私模式/无痕模式访问

### Q4: 证书生成后还需要做什么？

**A:**
1. 在局域网设备上安装 mkcert CA 证书（见下方说明）
2. 重启 Outline 服务
3. 清除浏览器的 HSTS 缓存（如果之前访问过）

## 在局域网设备上安装 mkcert CA 证书

即使证书包含了局域网 IP，设备仍需要信任 mkcert 的 CA 证书。

### 步骤 1：找到 CA 证书

在宿主机上：

```bash
# Linux
~/.local/share/mkcert/rootCA.pem

# macOS
~/Library/Application Support/mkcert/rootCA.pem

# Windows
%LOCALAPPDATA%\mkcert\rootCA.pem
```

### 步骤 2：复制到局域网设备

```bash
# 使用 scp
scp ~/.local/share/mkcert/rootCA.pem user@192.168.1.100:/tmp/rootCA.pem
```

### 步骤 3：在设备上安装

**Linux:**
```bash
sudo cp /tmp/rootCA.pem /usr/local/share/ca-certificates/mkcert-rootCA.crt
sudo update-ca-certificates
```

**macOS:**
```bash
# 双击 rootCA.pem 文件，在 Keychain Access 中安装
# 或使用命令行
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain rootCA.pem
```

**Windows:**
1. 双击 `rootCA.pem` 文件
2. 选择"安装证书"
3. 选择"本地计算机" → "将所有证书放入以下存储" → "受信任的根证书颁发机构"

## 最佳实践

1. **使用智能展开**：对于 `/16` 或更大的网段，使用默认的智能展开
2. **只包含必要的 IP**：如果只需要访问特定 IP，直接指定 IP 而不是整个网段
3. **定期更新证书**：证书有效期通常为 2-3 年，到期前需要重新生成
4. **备份 CA 证书**：保存 mkcert CA 证书，方便在局域网设备上安装
