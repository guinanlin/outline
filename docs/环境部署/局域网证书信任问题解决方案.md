# 局域网证书信任问题解决方案

## 问题描述

在局域网设备（192.168.8.246）上访问 `https://local.outline.dev:3300` 时，浏览器显示：
- ❌ "您的连接不是私密连接"
- ❌ `ERR_CERT_AUTHORITY_INVALID`
- ❌ "因为此网站使用了 HSTS"

**但实际情况：**
- ✅ 证书已包含你的 IP 地址（192.168.8.246）
- ✅ 证书内容是正确的
- ✅ 在宿主机上访问正常

## 根本原因

### 原因 1：局域网设备未安装 mkcert CA 根证书（主要原因）

证书是由 **mkcert development CA** 签发的，这是一个本地 CA（证书颁发机构）。浏览器只信任系统信任列表中的 CA，而局域网设备上没有安装这个 CA 证书，所以浏览器认为证书不受信任。

**证书信息：**
- 颁发者：`mkcert development CA, OU = ctyun@dty02, CN = mkcert ctyun@dty02`
- CA 证书位置（宿主机）：`/home/ctyun/.local/share/mkcert/rootCA.pem`

### 原因 2：浏览器 HSTS 缓存

如果之前访问过该域名，浏览器可能缓存了 HSTS（HTTP Strict Transport Security）策略，强制使用 HTTPS，即使证书无效也无法绕过。

### 原因 3：DNS 解析问题（次要）

`ping local.outline.dev` 解析到 `10.253.32.200`，这可能是因为：
- 局域网设备的 hosts 文件或 DNS 配置指向了其他地址
- 需要确保 `local.outline.dev` 解析到正确的服务器 IP

## 解决方案

### 步骤 1：获取 mkcert CA 证书

在宿主机上，CA 证书位于：
```
/home/ctyun/.local/share/mkcert/rootCA.pem
```

**方法 1：使用 SCP 复制到局域网设备**

```bash
# 在宿主机上执行（假设局域网设备用户名是 jianc，IP 是 192.168.8.246）
scp /home/ctyun/.local/share/mkcert/rootCA.pem jianc@192.168.8.246:C:\Users\jianc\Downloads\rootCA.pem
```

**方法 2：通过共享文件夹**

1. 在宿主机上创建共享文件夹，将 `rootCA.pem` 复制到共享文件夹
2. 在局域网设备上通过网络共享访问并下载

**方法 3：通过 HTTP 服务临时提供**

```bash
# 在宿主机上启动临时 HTTP 服务
cd /home/ctyun/.local/share/mkcert
python3 -m http.server 8080

# 在局域网设备浏览器访问：http://宿主机IP:8080/rootCA.pem
# 下载后记得停止 HTTP 服务
```

### 步骤 2：在 Windows 设备上安装 CA 证书

#### 方法 A：通过图形界面安装（推荐）

1. **下载证书文件**
   - 将 `rootCA.pem` 复制到 Windows 设备（如 `C:\Users\jianc\Downloads\rootCA.pem`）

2. **重命名文件扩展名**
   - 将 `rootCA.pem` 重命名为 `rootCA.crt`（Windows 需要 .crt 扩展名）

3. **安装证书**
   - 双击 `rootCA.crt` 文件
   - 选择 **"安装证书"**
   - 选择 **"本地计算机"**（需要管理员权限）
   - 点击 **"下一步"**
   - 选择 **"将所有证书放入下列存储"**
   - 点击 **"浏览"**
   - 选择 **"受信任的根证书颁发机构"**
   - 点击 **"确定"** → **"下一步"** → **"完成"**
   - 如果弹出安全警告，点击 **"是"**

4. **验证安装**
   - 打开 **"运行"**（Win+R）
   - 输入 `certmgr.msc` 并回车
   - 展开 **"受信任的根证书颁发机构"** → **"证书"**
   - 查找 **"mkcert ctyun@dty02"** 或 **"mkcert development CA"**
   - 如果找到，说明安装成功

#### 方法 B：通过命令行安装（需要管理员权限）

```cmd
# 以管理员身份打开命令提示符（CMD）或 PowerShell

# 方法 1：使用 certutil
certutil -addstore -f "Root" C:\Users\jianc\Downloads\rootCA.crt

# 方法 2：使用 PowerShell
Import-Certificate -FilePath "C:\Users\jianc\Downloads\rootCA.crt" -CertStoreLocation Cert:\LocalMachine\Root
```

### 步骤 3：清除浏览器 HSTS 缓存

#### Chrome/Edge 浏览器

1. **访问 HSTS 设置页面**
   - 在地址栏输入：`chrome://net-internals/#hsts`
   - 或：`edge://net-internals/#hsts`

2. **删除 HSTS 记录**
   - 在 **"Delete domain security policies"** 部分
   - 输入域名：`local.outline.dev`
   - 点击 **"Delete"**

3. **清除浏览器缓存（可选）**
   - 按 `Ctrl+Shift+Delete`
   - 选择 **"缓存的图片和文件"**
   - 点击 **"清除数据"**

#### Firefox 浏览器

1. **清除站点数据**
   - 按 `Ctrl+Shift+Delete`
   - 选择 **"站点数据"**
   - 搜索 `local.outline.dev`
   - 删除相关数据

2. **清除 HSTS 缓存（高级）**
   - 在地址栏输入：`about:config`
   - 搜索：`security.tls.insecure_fallback_hosts`
   - 添加 `local.outline.dev`（如果存在）

### 步骤 4：配置 DNS 解析（如果需要）

如果 `ping local.outline.dev` 解析到错误的 IP（如 `10.253.32.200`），需要配置 hosts 文件：

**Windows hosts 文件位置：**
```
C:\Windows\System32\drivers\etc\hosts
```

**编辑 hosts 文件（需要管理员权限）：**

1. 以管理员身份打开记事本
2. 打开文件：`C:\Windows\System32\drivers\etc\hosts`
3. 添加以下行（替换为实际的服务器 IP）：
   ```
   192.168.8.19  local.outline.dev
   ```
   **注意**：根据你的 ping 结果，服务器 IP 可能是 `192.168.8.19`（你的默认网关），或者需要确认实际的服务器 IP。

4. 保存文件
5. 刷新 DNS 缓存：
   ```cmd
   ipconfig /flushdns
   ```

### 步骤 5：测试访问

1. **完全关闭浏览器**（确保清除缓存生效）

2. **重新打开浏览器**

3. **访问网站**
   - 访问：`https://local.outline.dev:3300`
   - 或：`https://192.168.8.19:3300`（如果知道服务器 IP）

4. **检查证书**
   - 点击地址栏的锁图标
   - 查看证书信息
   - 应该显示 **"连接是安全的"** 或 **"证书有效"**

## 验证步骤

### 验证 1：检查证书是否包含你的 IP

在浏览器中：
1. 点击地址栏的锁图标
2. 点击 **"证书"** 或 **"连接是安全的"** → **"证书信息"**
3. 查看 **"使用者可选名称 (SAN)"**
4. 应该能看到 `192.168.8.246` 和其他 IP 地址

### 验证 2：检查 CA 证书是否已安装

**Windows：**
```cmd
certmgr.msc
# 查看 "受信任的根证书颁发机构" → "证书"
# 查找 "mkcert" 相关证书
```

**PowerShell：**
```powershell
Get-ChildItem -Path Cert:\LocalMachine\Root | Where-Object {$_.Subject -like "*mkcert*"}
```

### 验证 3：测试 HTTPS 连接

```cmd
# 使用 curl 测试（如果已安装）
curl -v https://local.outline.dev:3300/_health

# 或使用 PowerShell
Invoke-WebRequest -Uri https://local.outline.dev:3300/_health -SkipCertificateCheck
```

## 常见问题

### Q1: 安装证书后仍然显示不安全

**可能原因：**
1. HSTS 缓存未清除
2. 浏览器缓存未清除
3. 证书安装位置错误（应该安装到"受信任的根证书颁发机构"）

**解决方案：**
1. 完全关闭浏览器并重新打开
2. 清除 HSTS 缓存（见步骤 3）
3. 使用隐私模式/无痕模式测试
4. 验证证书安装位置

### Q2: 证书安装需要管理员权限

**解决方案：**
- 右键点击证书文件，选择 **"以管理员身份运行"**
- 或在管理员权限的命令提示符中安装

### Q3: 多个设备需要访问

**解决方案：**
- 需要在每台设备上单独安装 CA 证书
- 或者将 CA 证书放在共享位置，每台设备下载安装

### Q4: DNS 解析到错误的 IP

**解决方案：**
- 配置 hosts 文件（见步骤 4）
- 或使用 IP 地址直接访问：`https://192.168.8.19:3300`

### Q5: 证书有效期

**当前证书有效期：**
- 从：2026-01-14
- 到：2028-04-14

证书到期前需要重新生成并重新构建镜像。

## 快速检查清单

- [ ] CA 证书已从宿主机复制到局域网设备
- [ ] CA 证书已安装到 Windows 的"受信任的根证书颁发机构"
- [ ] 浏览器 HSTS 缓存已清除
- [ ] 浏览器已完全关闭并重新打开
- [ ] hosts 文件已配置（如果需要）
- [ ] DNS 缓存已刷新（`ipconfig /flushdns`）
- [ ] 使用隐私模式测试访问

## 如果问题仍然存在

1. **检查证书链**
   ```cmd
   # 在局域网设备上
   openssl s_client -connect local.outline.dev:3300 -showcerts
   ```

2. **检查服务器 IP**
   - 确认服务器实际 IP 地址
   - 确认端口 3300 是否开放

3. **检查防火墙**
   - 确认防火墙允许 3300 端口的 HTTPS 连接

4. **查看详细错误**
   - 在浏览器开发者工具（F12）中查看网络标签
   - 查看证书错误的详细信息

## 总结

问题的核心是：**局域网设备需要信任 mkcert 的 CA 证书**。一旦安装了 CA 证书，所有由该 CA 签发的证书都会被浏览器信任。

安装 CA 证书后，即使证书包含的 IP 地址正确，浏览器也会信任该证书，因为：
1. 证书由已信任的 CA 签发
2. 证书包含正确的域名和 IP 地址
3. 证书未过期且格式正确
