# 证书生成和镜像构建流程

## 概述

本文档说明如何在宿主机上生成 SSL 证书，然后通过 Docker 构建将证书包含到镜像中的完整流程。

## 核心思路

1. **在宿主机上生成证书**：使用 `yarn install-local-ssl` 在宿主机上生成证书
2. **证书自动包含到镜像**：Dockerfile 会复制整个项目，证书文件会被包含在镜像中
3. **重新构建镜像**：构建新镜像时，证书会自动包含

## 完整操作流程

### 方式 1：使用 Makefile（推荐）

```bash
# 进入项目目录
cd /media/ctyun/datadisk1/exp-projects/outline

# 构建镜像（会自动生成证书）
make build
```

**说明**：
- `make build` 会自动执行：
  1. 生成 SSL 证书（使用默认网段 `192.168.0.0/16`）
  2. 构建 Docker 镜像

### 方式 2：使用构建脚本

```bash
# 进入项目目录
cd /media/ctyun/datadisk1/exp-projects/outline

# 使用默认网段（192.168.0.0/16）
./build-images.sh

# 或指定自定义网段
LOCAL_NETWORK=192.168.0.0/16 ./build-images.sh
```

### 方式 3：手动执行（完全控制）

```bash
# 步骤 1: 生成证书
cd /media/ctyun/datadisk1/exp-projects/outline

# 指定网段生成证书
LOCAL_NETWORK=192.168.0.0/16 yarn install-local-ssl

# 如果需要强制重新生成
LOCAL_NETWORK=192.168.0.0/16 FORCE_REGENERATE_CERT=true yarn install-local-ssl

# 步骤 2: 验证证书已生成
ls -la server/config/certs/
# 应该看到:
# - public.cert
# - private.key

# 步骤 3: 构建镜像
./build-images.sh
# 或
make build
```

## 详细步骤说明

### 步骤 1：生成 SSL 证书

#### 1.1 基本用法（使用默认网段）

```bash
LOCAL_NETWORK=192.168.0.0/16 yarn install-local-ssl
```

#### 1.2 自定义网段

```bash
# 单个网段
LOCAL_NETWORK=192.168.0.0/16 yarn install-local-ssl

# 多个网段
LOCAL_NETWORK=192.168.0.0/16,10.0.0.0/8 yarn install-local-ssl

# 网段 + 特定 IP
LOCAL_NETWORK=192.168.0.0/16,192.168.1.100 yarn install-local-ssl
```

#### 1.3 强制重新生成

如果证书已存在，需要先删除旧证书：

```bash
# 删除旧证书
rm -f server/config/certs/public.cert server/config/certs/private.key

# 重新生成
LOCAL_NETWORK=192.168.0.0/16 FORCE_REGENERATE_CERT=true yarn install-local-ssl
```

#### 1.4 验证证书

```bash
# 查看证书包含的 IP
openssl x509 -in server/config/certs/public.cert -noout -text | grep -A 30 "Subject Alternative Name"
```

### 步骤 2：构建 Docker 镜像

#### 2.1 使用构建脚本（推荐）

```bash
# 使用默认网段
./build-images.sh

# 或指定网段
LOCAL_NETWORK=192.168.0.0/16 ./build-images.sh
```

构建脚本会自动：
1. 检查并生成证书（如果未设置 `LOCAL_NETWORK`，使用默认值）
2. 构建基础镜像（`outline-base:latest`）
3. 构建最终镜像（`outline:latest`）
4. 验证证书已包含在镜像中

#### 2.2 使用 Makefile

```bash
make build
```

#### 2.3 手动构建

```bash
# 构建基础镜像
docker build \
  -f Dockerfile.base \
  -t outline-base:latest \
  --build-arg APP_PATH=/opt/outline \
  .

# 构建最终镜像
docker build \
  -f Dockerfile \
  -t outline:latest \
  --build-arg BASE_IMAGE=outline-base:latest \
  --build-arg APP_PATH=/opt/outline \
  .
```

### 步骤 3：验证证书在镜像中

```bash
# 检查镜像中是否包含证书
docker run --rm outline:latest ls -la /opt/outline/server/config/certs/

# 查看证书内容
docker run --rm outline:latest openssl x509 -in /opt/outline/server/config/certs/public.cert -noout -text | grep -A 30 "Subject Alternative Name"
```

### 步骤 4：部署新镜像

```bash
# 停止旧容器
docker compose -f docker-compose.dokploy.yml down

# 启动新容器（使用新镜像）
docker compose -f docker-compose.dokploy.yml up -d

# 查看日志
docker compose -f docker-compose.dokploy.yml logs -f outline
```

## 环境变量说明

### LOCAL_NETWORK

指定局域网网段（CIDR 格式）或单个 IP 地址。

**示例：**
```bash
# 单个网段
LOCAL_NETWORK=192.168.0.0/16

# 多个网段
LOCAL_NETWORK=192.168.0.0/16,10.0.0.0/8

# 网段 + 特定 IP
LOCAL_NETWORK=192.168.0.0/16,192.168.1.100
```

### FORCE_REGENERATE_CERT

强制重新生成证书（即使证书已存在）。

```bash
FORCE_REGENERATE_CERT=true LOCAL_NETWORK=192.168.0.0/16 yarn install-local-ssl
```

### EXPAND_NETWORK_ALL

控制 CIDR 网段的展开方式：
- `false`（默认）：智能展开，只包含关键 IP
- `true`：完整展开，包含网段内所有 IP（不推荐用于大网段）

```bash
# 完整展开（仅适用于小网段，如 /24）
LOCAL_NETWORK=192.168.1.0/24 EXPAND_NETWORK_ALL=true yarn install-local-ssl
```

## 常见场景

### 场景 1：首次部署

```bash
# 1. 生成证书
LOCAL_NETWORK=192.168.0.0/16 yarn install-local-ssl

# 2. 构建镜像
./build-images.sh

# 3. 部署
docker compose -f docker-compose.dokploy.yml up -d
```

### 场景 2：更新证书（更换网段）

```bash
# 1. 删除旧证书
rm -f server/config/certs/public.cert server/config/certs/private.key

# 2. 生成新证书
LOCAL_NETWORK=10.0.0.0/8 yarn install-local-ssl

# 3. 重新构建镜像
./build-images.sh

# 4. 重启容器
docker compose -f docker-compose.dokploy.yml restart outline
```

### 场景 3：代码更新 + 证书更新

```bash
# 1. 更新代码（git pull 等）
git pull

# 2. 更新证书（如果需要）
LOCAL_NETWORK=192.168.0.0/16 yarn install-local-ssl

# 3. 重新构建镜像
./build-images.sh

# 4. 重启容器
docker compose -f docker-compose.dokploy.yml down
docker compose -f docker-compose.dokploy.yml up -d
```

## 验证和测试

### 验证证书在宿主机上

```bash
# 检查证书文件
ls -la server/config/certs/

# 查看证书内容
openssl x509 -in server/config/certs/public.cert -noout -text | grep -A 30 "Subject Alternative Name"
```

### 验证证书在镜像中

```bash
# 检查证书文件
docker run --rm outline:latest ls -la /opt/outline/server/config/certs/

# 查看证书内容
docker run --rm outline:latest openssl x509 -in /opt/outline/server/config/certs/public.cert -noout -text | grep -A 30 "Subject Alternative Name"
```

### 测试 HTTPS 连接

```bash
# 从局域网设备测试
curl -v https://192.168.1.255:3300/
curl -v https://local.outline.dev:3300/
```

## 注意事项

1. **证书目录权限**：确保证书目录存在且有写权限
   ```bash
   mkdir -p server/config/certs
   chmod 755 server/config/certs
   ```

2. **mkcert 安装**：确保宿主机上已安装 mkcert
   ```bash
   # 检查是否安装
   which mkcert
   
   # 如果未安装，参考：https://github.com/FiloSottile/mkcert#installation
   ```

3. **证书有效期**：mkcert 生成的证书通常有效期为 2-3 年

4. **.gitignore**：确保证书文件不会被提交到 Git
   ```bash
   # 检查 .gitignore
   cat .gitignore | grep certs
   ```

5. **镜像大小**：证书文件很小，不会显著增加镜像大小

## 故障排查

### 问题 1：证书生成失败

**错误信息**：`SSL certificates could not be generated`

**解决方案**：
1. 检查 mkcert 是否安装：`which mkcert`
2. 检查证书目录权限：`ls -la server/config/certs/`
3. 手动安装 mkcert：参考 [mkcert 安装文档](https://github.com/FiloSottile/mkcert#installation)

### 问题 2：证书未包含在镜像中

**检查方法**：
```bash
docker run --rm outline:latest ls -la /opt/outline/server/config/certs/
```

**解决方案**：
1. 确保证书在构建前已生成
2. 检查 `.dockerignore` 是否排除了证书目录
3. 重新构建镜像

### 问题 3：证书包含的 IP 不正确

**检查方法**：
```bash
openssl x509 -in server/config/certs/public.cert -noout -text | grep -A 30 "Subject Alternative Name"
```

**解决方案**：
1. 删除旧证书
2. 使用正确的 `LOCAL_NETWORK` 重新生成
3. 重新构建镜像

## 最佳实践

1. **在构建前生成证书**：确保证书在 Docker 构建前已生成
2. **使用环境变量**：通过 `LOCAL_NETWORK` 环境变量配置网段，而不是硬编码
3. **版本控制**：不要将证书文件提交到 Git（已在 .gitignore 中）
4. **定期更新**：证书到期前需要重新生成并重新构建镜像
5. **文档记录**：记录使用的网段配置，方便后续维护
