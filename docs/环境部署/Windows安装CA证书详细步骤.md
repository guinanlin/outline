# Windows 安装 mkcert CA 证书详细步骤

## 重要说明

**Chrome 浏览器使用 Windows 系统的证书存储**，所以需要在 Windows 系统级别安装证书，而不是在 Chrome 浏览器中直接导入。

## 方法 1：通过图形界面安装（推荐，最简单）

### 步骤 1：准备证书文件

1. 确保你已经将 `rootCA.crt` 文件复制到 Windows 设备
2. 文件位置：例如 `C:\Users\jianc\Downloads\rootCA.crt`

### 步骤 2：打开证书文件

1. **双击 `rootCA.crt` 文件**
   - 如果系统询问"您想要打开此文件吗？"，点击 **"打开"**

2. **查看证书信息窗口**
   - 会显示证书的详细信息
   - 颁发者：`mkcert development CA, OU = ctyun@dty02`
   - 点击 **"安装证书"** 按钮

### 步骤 3：选择安装位置

1. **证书导入向导 - 存储位置**
   - 选择 **"本地计算机"**（重要！）
   - ⚠️ 如果只选择"当前用户"，可能不会对所有应用生效
   - 点击 **"下一步"**
   - 如果弹出 UAC（用户账户控制）提示，点击 **"是"**（需要管理员权限）

### 步骤 4：选择证书存储

1. **证书导入向导 - 证书存储**
   - 选择 **"将所有证书放入下列存储"**
   - 点击 **"浏览"** 按钮

2. **选择证书存储**
   - 在弹出的窗口中，勾选 **"显示物理存储区"**（如果看到）
   - 选择 **"受信任的根证书颁发机构"**
   - 点击 **"确定"**

3. **确认选择**
   - 应该显示：`受信任的根证书颁发机构`
   - 点击 **"下一步"**

### 步骤 5：完成安装

1. **证书导入向导 - 完成**
   - 点击 **"完成"**

2. **安全警告**
   - 会弹出警告："您即将从一个证书颁发机构安装证书..."
   - 点击 **"是"** 确认安装

3. **安装成功**
   - 显示："导入成功"
   - 点击 **"确定"**

## 方法 2：通过证书管理器安装（更精确控制）

### 步骤 1：打开证书管理器

1. **按 `Win + R` 打开运行对话框**
2. **输入：`certmgr.msc`**
3. **按回车**（可能需要管理员权限）

### 步骤 2：导航到证书存储

1. **在左侧树形结构中**
   - 展开 **"证书 - 本地计算机"**
   - 展开 **"受信任的根证书颁发机构"**
   - 点击 **"证书"** 文件夹

### 步骤 3：导入证书

1. **右键点击 "证书" 文件夹**
   - 选择 **"所有任务"** → **"导入"**

2. **证书导入向导**
   - 点击 **"下一步"**

3. **选择文件**
   - 点击 **"浏览"**
   - 文件类型选择：**"所有文件 (*.*)"**
   - 找到并选择 `rootCA.crt` 文件
   - 点击 **"打开"**
   - 点击 **"下一步"**

4. **证书存储**
   - 选择 **"将所有证书放入下列存储"**
   - 存储位置应该显示：**"受信任的根证书颁发机构"**
   - 如果不是，点击 **"浏览"** 选择正确的存储
   - 点击 **"下一步"**

5. **完成**
   - 点击 **"完成"**
   - 确认安全警告
   - 看到 "导入成功" 提示

### 步骤 4：验证安装

1. **在证书管理器中**
   - 查看 **"受信任的根证书颁发机构"** → **"证书"**
   - 应该能看到 **"mkcert ctyun@dty02"** 或 **"mkcert development CA"**

2. **查看证书详情**
   - 双击证书
   - 确认颁发者是：`mkcert development CA, OU = ctyun@dty02`

## 方法 3：通过命令行安装（适合批量部署）

### 使用 certutil（需要管理员权限）

1. **以管理员身份打开命令提示符（CMD）**
   - 按 `Win + X`
   - 选择 **"Windows PowerShell (管理员)"** 或 **"命令提示符 (管理员)"**

2. **执行安装命令**
   ```cmd
   certutil -addstore -f "Root" C:\Users\jianc\Downloads\rootCA.crt
   ```

3. **验证安装**
   ```cmd
   certutil -store "Root" | findstr "mkcert"
   ```

### 使用 PowerShell（需要管理员权限）

1. **以管理员身份打开 PowerShell**

2. **执行安装命令**
   ```powershell
   Import-Certificate -FilePath "C:\Users\jianc\Downloads\rootCA.crt" -CertStoreLocation Cert:\LocalMachine\Root
   ```

3. **验证安装**
   ```powershell
   Get-ChildItem -Path Cert:\LocalMachine\Root | Where-Object {$_.Subject -like "*mkcert*"}
   ```

## 验证安装是否成功

### 方法 1：通过证书管理器验证

1. 打开 `certmgr.msc`
2. 展开 **"受信任的根证书颁发机构"** → **"证书"**
3. 查找证书，颁发者应该包含 **"mkcert"**

### 方法 2：通过命令行验证

```cmd
# CMD
certutil -store "Root" | findstr "mkcert"

# PowerShell
Get-ChildItem -Path Cert:\LocalMachine\Root | Where-Object {$_.Subject -like "*mkcert*"}
```

### 方法 3：通过浏览器测试

1. **清除 Chrome HSTS 缓存**
   - 访问：`chrome://net-internals/#hsts`
   - 删除 `local.outline.dev` 的 HSTS 记录

2. **完全关闭 Chrome 浏览器**

3. **重新打开 Chrome**

4. **访问网站**
   - 访问：`https://local.outline.dev:3300`
   - 应该不再显示证书错误

5. **查看证书信息**
   - 点击地址栏的锁图标
   - 点击 **"连接是安全的"** → **"证书有效"**
   - 查看证书链，应该能看到 mkcert CA 证书

## 常见问题

### Q1: 安装时提示"需要管理员权限"

**解决方案：**
- 右键点击 `rootCA.crt` 文件
- 选择 **"以管理员身份运行"**
- 或在管理员权限的命令提示符中安装

### Q2: 安装后 Chrome 仍然显示不安全

**可能原因和解决方案：**

1. **HSTS 缓存未清除**
   - 访问 `chrome://net-internals/#hsts`
   - 删除 `local.outline.dev` 的记录
   - 完全关闭并重新打开 Chrome

2. **证书安装到错误的位置**
   - 确认安装到 **"受信任的根证书颁发机构"**（LocalMachine\Root）
   - 不是 "当前用户" 的存储

3. **浏览器缓存**
   - 使用隐私模式/无痕模式测试
   - 或清除浏览器缓存

### Q3: 证书安装后，其他浏览器也受影响吗？

**答案：**
- ✅ **是的**，因为安装到系统级别的证书存储
- Chrome、Edge、Firefox 等浏览器都会使用系统证书存储
- 安装一次，所有浏览器都会信任

### Q4: 如何卸载证书？

**方法：**
1. 打开 `certmgr.msc`
2. 展开 **"受信任的根证书颁发机构"** → **"证书"**
3. 找到 mkcert 证书
4. 右键 → **"删除"**
5. 确认删除

### Q5: 安装证书安全吗？

**说明：**
- mkcert 是用于本地开发的工具
- 只应该在你信任的本地网络中使用
- 不要在生产环境或公共网络中使用
- 证书只对本地开发有效

## 快速检查清单

- [ ] `rootCA.crt` 文件已复制到 Windows 设备
- [ ] 证书已安装到 **"受信任的根证书颁发机构"**（LocalMachine\Root）
- [ ] 通过 `certmgr.msc` 验证证书已存在
- [ ] Chrome HSTS 缓存已清除（`chrome://net-internals/#hsts`）
- [ ] Chrome 浏览器已完全关闭并重新打开
- [ ] 使用隐私模式测试访问
- [ ] 访问 `https://local.outline.dev:3300` 不再显示证书错误

## 如果仍然有问题

1. **检查证书安装位置**
   ```cmd
   certutil -store "Root" | findstr "mkcert"
   ```

2. **检查证书详细信息**
   - 在证书管理器中双击证书
   - 确认颁发者信息正确

3. **尝试使用 IP 地址访问**
   - `https://192.168.8.19:3300`（使用服务器实际 IP）

4. **查看 Chrome 详细错误**
   - 按 `F12` 打开开发者工具
   - 查看 **"Console"** 或 **"Network"** 标签
   - 查看证书错误的详细信息

5. **检查服务器证书**
   - 确认服务器正在使用包含你 IP 的证书
   - 确认证书未过期
